<!-- HTML header for doxygen 1.8.16-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rotor: Event loops &amp; platforms</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="extra.css" rel="stylesheet" type="text/css" />
</head>
<body>
<a href="http://www.reactivemanifesto.org/"> <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src="//d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-white-right.png"> </a>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">rotor
   </div>
   <div id="projectbrief">Event loop friendly C++ actor micro-framework</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_b_development_cpp_cpp-rotor_docs_Loops.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Event loops &amp; platforms </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Event loops &amp; backends</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">event loop  </th><th class="markdownTableHeadNone">support status   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="https://www.boost.org/doc/libs/release/libs/asio/" title="Boost Asio">boost-asio</a>  </td><td class="markdownTableBodyNone">supported   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="https://www.wxwidgets.org/" title="wxWidgets">wx-widgets</a>  </td><td class="markdownTableBodyNone">supported   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="http://software.schmorp.de/pkg/libev.html">ev</a>  </td><td class="markdownTableBodyNone">supported   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="https://en.cppreference.com/w/cpp/thread/thread">std-thread</a>  </td><td class="markdownTableBodyNone">supported   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="https://libevent.org/">libevent</a>  </td><td class="markdownTableBodyNone">planned   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="https://libuv.org/">libuv</a>  </td><td class="markdownTableBodyNone">planned   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="https://www.gtk.org/">gtk</a>  </td><td class="markdownTableBodyNone">planned   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a href="https://www.qt.io/">qt</a>  </td><td class="markdownTableBodyNone">planned   </td></tr>
</table>
<p>If you need some other event loop or speedup inclusion of a planned one, please file an <a href="https://github.com/basiliscos/cpp-rotor/issues">issue</a>.</p>
<h1>platforms</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">event loop  </th><th class="markdownTableHeadNone">support status   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">linux  </td><td class="markdownTableBodyNone">supported   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">windows  </td><td class="markdownTableBodyNone">supported   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">macos  </td><td class="markdownTableBodyNone">supported   </td></tr>
</table>
<h1>Notes on std::thread backend</h1>
<p>This backend was developed to support <b>blocking</b> operations, which have the same effect as <code>std::this_thread::sleep_for</code> invocation. This is suitable for disk I/O operations, working with database or using third-party libraries with synchronous semantics.</p>
<p>It should be noted, that using blocking operations have some consequences, e.g. actors on a thread, which executes blocking operation, will not be able to respond to messages, namely, to cancellation requests. There is no universal remedy, however, this can be smoothed: split long I/O operation into "continuation-message" with series of smaller I/O chunks and when the current chunk is complete, just send self a message with all work and index of the next chunk. It will make an actor more responsive, giving it some breadth to pull external messages, trigger timeouts, and, finally, give it a chance to react to cancellation notice.</p>
<p>When there are no messages, the backend uses <code>sleep_for</code> / <code>sleep_until</code> functions to wait either external message message or until nearest timout occurs. To let the things work properly, the message handlers with blocking operations should specially marked (<code>tag_io()</code>), to correctly update timers before, after and inside the handler.</p>
<p>See, <code>Blocking I/O multiplexing</code> in <code>Patterns</code>.</p>
<h1>Integration with event loops</h1>
<p><code>rotor</code> is designed to be integrated with event loops, which actually perform some I/O, spawn and trigger timers and other asynchronous operations, which can be invoked from an actor or a supervisor. The key accessor here is a supervisor.</p>
<p>First, the final (concrete) supervisor have to be obtained. Then, for safety, the intrusive pointer to the actor should be created(2), and then loop-specific async operation should be initiated(3), where the pointer should be moved(4). Finally, when the result of I/O operation is transformed into rotor message or messages(5), which should be sent, the supervisor should be asked to perform rotor mechanics, i.e. deliver message(s)(6). Let's illustrate it on timer using <a href="https://www.boost.org/doc/libs/release/libs/asio/" title="Boost Asio">boost-asio</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>my_actor_t : r::actor_base_t {</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> timer_ptr_t = std::unique_ptr&lt;boost::asio::deadline_timer&gt;;</div>
<div class="line">    timer_ptr_t timer;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> on_trigger(message::some_message_t&amp;) noexcept {</div>
<div class="line">        <span class="keyword">using</span> <a class="code" href="namespacerotor.html#a9ebe7c23e46e63f18335110b2a76548c">actor_ptr_t</a> = r::intrusive_ptr_t&lt;my_actor_t&gt;;</div>
<div class="line">        <span class="keyword">auto</span> sup = <span class="keyword">static_cast&lt;</span>r::asio::supervisor_asio_t*<span class="keyword">&gt;</span>(supervisor); <span class="comment">// (1)</span></div>
<div class="line">        <span class="keyword">auto</span> actor_ptr = <a class="code" href="namespacerotor.html#a9ebe7c23e46e63f18335110b2a76548c">actor_ptr_t</a>(<span class="keyword">this</span>); <span class="comment">// (2)</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// (3)</span></div>
<div class="line">        <span class="keyword">auto</span>&amp; strand = sup_ptr-&gt;get_strand();</div>
<div class="line">        timer = std::make_unique&lt;boost::asio::deadline_timer&gt;(strand);</div>
<div class="line">        timer-&gt;expires_from_now(timeout);</div>
<div class="line">        timer-&gt;async_wait([<span class="keyword">this</span>, actor_ptr = std::move(actor_ptr)](<span class="keyword">auto</span>&amp; ec){ <span class="comment">// (4)</span></div>
<div class="line">            ...;</div>
<div class="line">            send&lt;message::io_result_t&gt;(...); <span class="comment">// (5)</span></div>
<div class="line">            get_supervisor()-&gt;do_process(); <span class="comment">// (6)</span></div>
<div class="line">            (void)actor_ptr;</div>
<div class="line">        });</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h1>Adding loop support guide</h1>
<p>Adding new event loop to <code>rotor</code> is rather simple: the new <code>supervisor</code> class should be derived from <code>supervisor_t</code>, and the following methods should be implemented:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> do_start_timer(<span class="keyword">const</span> pt::time_duration &amp;interval, timer_handler_base_t &amp;handler) noexcept <span class="keyword">override</span>;</div>
<div class="line"><span class="keywordtype">void</span> do_cancel_timer(request_id_t timer_id) noexcept <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> start() noexcept override;</div>
<div class="line"><span class="keywordtype">void</span> shutdown() noexcept override;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> enqueue(<a class="code" href="namespacerotor.html">rotor</a>::message_ptr_t) noexcept override;</div>
</div><!-- fragment --><p>The <code>enqueue</code> method is responsible for puting an <code>message</code> into <code>supervisor</code> inbound queue <em>probably</em> in <b>thread-safe manner</b> to allow accept messages from other supervisors/loops (thread-safety requirement) or just from some outer context, when supervisor is still not running on the loop (can be thread-unsafe). The second requirement is to let the supervisor process all it's inbound messages <em>in a loop context</em>, may be with supervisor-specific context.</p>
<p>The <code>start</code> and <code>shutdown</code> are just convenient methods to start processing messages in event loop context (for <code>start</code>) and send a shutdown messages and process event loop in event loop context .</p>
<p><code>do_start_timer</code> should strate a new timer, whose id (request_id_t) can be get via the <code>timer_handler_base_t</code>. The <code>do_cancel_timer</code> should cancel timer and <b>immediately</b> invoke the timer_handler with <code>cancelled = true</code>. The backend timer cancel implementation can be delayed, but that's actually outsize of <code>rotor</code>.</p>
<p>Here is an skeleton example for <code>enqueue</code>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> some_supervisor_t::enqueue(message_ptr_t message) noexcept {</div>
<div class="line">    <a class="code" href="namespacerotor_1_1asio.html#abe1323c9afeef7ace640615c830867a3">supervisor_ptr_t</a> <span class="keyword">self</span>{<span class="keyword">this</span>};    <span class="comment">// increase ref-counter</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; loop = ...                <span class="comment">// get loop somehow, e.g. from loop-specific context</span></div>
<div class="line">    loop.invoke_later([<span class="keyword">self</span> = std::move(<span class="keyword">self</span>), message = std::move(message)]() {</div>
<div class="line">        <span class="keyword">auto</span> &amp;sup = *<span class="keyword">self</span>;</div>
<div class="line">        sup.put(std::move(message));    <span class="comment">// put message into inbound queue</span></div>
<div class="line">        sup.do_process();               <span class="comment">// process inbound queue</span></div>
<div class="line">    });</div>
<div class="line">}</div>
</div><!-- fragment --><p>How to get loop and what method invoke on it, is the implementation-specific information. For example, loop refrence can be passed on <code>supervisor</code> constructor. The <code>invoke_later</code> (alternative names: <code>postpone</code>, <code>CallAfter</code>, <code>delay</code>, <code>dispatch</code>) is loop-specific method how to invoke something on in a thread-safe way. Please note, that <code>supervisor</code> instance is captured via intrusive pointer to make sure it is alive in the loop context invocations.</p>
<p>The timer-related methods are loop- or application-specific. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="anamespacerotor_1_1asio_html_abe1323c9afeef7ace640615c830867a3"><div class="ttname"><a href="namespacerotor_1_1asio.html#abe1323c9afeef7ace640615c830867a3">rotor::asio::supervisor_ptr_t</a></div><div class="ttdeci">intrusive_ptr_t&lt; supervisor_asio_t &gt; supervisor_ptr_t</div><div class="ttdoc">intrusive pointer for boost::asio supervisor</div><div class="ttdef"><b>Definition:</b> system_context_asio.h:21</div></div>
<div class="ttc" id="anamespacerotor_html_a9ebe7c23e46e63f18335110b2a76548c"><div class="ttname"><a href="namespacerotor.html#a9ebe7c23e46e63f18335110b2a76548c">rotor::actor_ptr_t</a></div><div class="ttdeci">intrusive_ptr_t&lt; actor_base_t &gt; actor_ptr_t</div><div class="ttdoc">intrusive pointer for actor</div><div class="ttdef"><b>Definition:</b> forward.hpp:22</div></div>
<div class="ttc" id="anamespacerotor_html"><div class="ttname"><a href="namespacerotor.html">rotor</a></div><div class="ttdoc">Basic namespace for all rotor functionalities.</div><div class="ttdef"><b>Definition:</b> actor_base.h:18</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
